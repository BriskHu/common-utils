<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>数据库管理工具</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../layui/css/layui.css" media="all">
</head>
<body>

<form class="layui-form" name="myform" lay-filter="dbTableListFilter" method="post" action="">
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">使用的数据库</label>
        <div class="layui-input-inline" style="width: 300px;">
            <select name="dbListName" lay-filter="dbListFilter" id="dbListId">
                <option value="">请选择数据库</option>
            </select>
        </div>

        <label class="layui-form-label" style="width: 100px;">执行操作的表</label>
        <div class="layui-input-inline" style="width: 500px;">
            <select name="tableListName" lay-filter="tableListFilter" id="tableListId">
                <option value="">请选择要操作的表</option>
            </select>
        </div>
    </div>

</form>


<script src="../js/config.js" type="text/javascript"></script>

<script>
    var currentDatabase = "";
    var currentTable = "";

    $(document).ready(function () {
        console.info("[ready] page load finished.");
        layui.use(['form'], function () {
            var form = layui.form;
            getDbList(form);
        })
    });

    layui.use(['element', 'layer', 'form'], function () {
        var form = layui.form,
            layer = layui.layer;

        form.on('select(dbListFilter)', function (dbName) {
            console.info("[dbListFilter] dbName=" + dbName);

            if (Object.is(dbName.value, "undefined") || Object.is(dbName.value, null)) {
                getDbList(form);
                useDatabase(form, currentDatabase);
            } else {
                useDatabase(form, dbName.value);
            }
            getTableList(form, currentDatabase);
        });

        form.on('select(tableListFilter)', function (tableName) {
            console.info("[tableListFilter] tableName=" + tableName.value);

            if (Object.is(tableName.value, "undefined") || Object.is(tableName.value, null)) {
                layer.msg('没有选择数据表');
                getTableList(form, currentDatabase);
            } else {

            }
        })


    });

    /**
     * 获取数据库列表
     * @param form
     */
    function getDbList(form) {
        console.debug("[getDbList] form = " + form);
        $.ajax({
            type: 'get',
            url: 'http://127.0.0.1:9918/dbadmin/database/showDatabases',
            // data: {dbListId: dbName.value},
            // dataType: 'json',

            beforeSend: function () {
                console.log('[getDbList] 执行请求：url = ' + this.url);
            },

            // async: true,
            success: function (queriedDbList) {
                console.log("[getDbList] url = " + this.url + ", response = " + queriedDbList);
                queriedDbList = JSON.parse(queriedDbList);

                var option = '';
                for (var i = 0; i < queriedDbList.length; i++) {
                    option += "<option value='" + queriedDbList[i] + "'>" + queriedDbList[i] + "</option>";
                }

                currentDatabase = queriedDbList[0];
                $("#dbListId").html(option);     // 将option的拼接内容加入的select中，注意选择器是select的id。
                form.render('select', 'dbTableListFilter');      // 重点：重新渲染select。
            },

            error: function () {
                console.error("[getDbList] 获取数据库列表出错");
                alert("获取数据库列表出错。");
            }
        });
    }

    /**
     * 切换数据库
     * @param form
     * @param dbName
     */
    function useDatabase(form, dbName) {
        console.info("[useDatabase] form = " + form + ", dbName = " + dbName);

        if (dbName != null && dbName.length > 0) {
            $.ajax({
                type: 'get',
                url: contextPath + '/database/useDatabase/' + dbName,

                beforeSend: function () {
                    console.log('[useDatabase] 执行请求：url = ' + this.url);
                },

                success: function (queriedTableList) {
                    getTableList(form, dbName);
                },

                error: function () {
                    console.error("[useDatabase] 切换数据库出错");
                    alert("切换数据库出错。");
                }
            });
        }else {
            console.error("[useDatabase] 没有选择数据库");
            alert("没有选择数据库。");
        }
    }

    /**
     * 获取指定数据库的所有表
     * @param form
     * @param dbName
     */
    function getTableList(form, dbName) {
        console.debug("[getTableList] form = " + form + ", dbName = " + dbName);
        $.ajax({
            type: 'get',
            url: contextPath + '/database/showTables',
            // data: dbName,

            beforeSend: function () {
                console.log('[getTableList] 执行请求：url = ' + this.url);
            },

            success: function (queriedTableList) {
                console.log("[getTableList] url = " + this.url + ", response = " + queriedTableList);
                queriedTableList = JSON.parse(queriedTableList);

                var option = '';
                for (var i = 0; i < queriedTableList.length; i++) {
                    option += "<option value='" + queriedTableList[i] + "'>" + queriedTableList[i] + "</option>";
                }
                $("#tableListId").html(option);
                form.render('select', 'dbTableListFilter');
            },

            error: function () {
                console.error("[getTableList] 选择数据表出错");
                alert("选择数据表出错。");
            }
        });
    }

    /**
     * 获取指定表的所有字段
     * @param form
     * @param tableName
     */
    function getFieldList(form, tableName) {

    }


</script>

</body>
</html>