<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>数据库管理工具</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../layui/css/layui.css" media="all">
</head>
<body>

<form class="layui-form" name="myform" method="post" action="">
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 0px;">使用的数据库</label>
        <div class="layui-input-inline" style="width: 300px;">
            <select name="dbListName" lay-filter="dbListFilter" id="dbListId">
                <option value="">请选择数据库</option>
            </select>
        </div>

        <label class="layui-form-label" style="width: 0px;">执行操作的表</label>
        <div class="layui-input-inline" style="width: 500px;">
            <select name="tableListName" lay-filter="tableListFilter" id="tableListId">
                <option value="">请选择要操作的表</option>
            </select>
        </div>
    </div>

</form>


<!--<script src="../layui/layui.all.js" charset="utf-8"></script>-->
<script src="../js/config.js" type="text/javascript"></script>

<script>
    conf.includeJs(conf.jQuery);
    conf.includeJs(conf.layuiAll);
    // conf.includeJsWithCharset(conf.layuiAll, conf.utf8);

    layui.use(['element', 'layer', 'form'], function () {
        var form = layui.form,
            layer = layui.layer;

        form.on('select(dbListFilter)', function (dbName) {
            layer.msg('go here');
            if (dbName === null) {
                getDbList(form, dbName);
            } else if (dbName != undefined) {
                getTableList(form, dbName);
            }
            layer.msg('end');
        });

    });

    /**
     * 获取数据库列表
     * @param form
     */
    function getDbList(form) {
        console.debug("[getDbList] form = " + form);
        $.ajax({
            type: 'get',
            url: 'http://127.0.0.1:9918/dbadmin/database/showDatabases',
            // data: {dbListId: dbName.value},
            // dataType: 'json',

            beforeSend: function () {
                console.log('[getDbList] 执行请求：url = ' + this.url);
            },

            // async: true,
            success: function (queriedDbList) {
                console.log("[getDbList] url = " + this.url + ", response = " + queriedDbList);
                queriedDbList = JSON.parse(queriedDbList);

                var option = '';
                for (var i = 0; i < queriedDbList.length; i++) {
                    option += "<option value='" + queriedDbList[i] + "'>" + queriedDbList[i] + "</option>";
                }
                $("#dbListId").html(option);     // 将option的拼接内容加入的select中，注意选择器是select的id。
                form.render('select', 'dbListFilter');      // 重点：重新渲染select。
            },

            error: function () {
                console.error("[getDbList] 获取数据库列表出错");
                alert("获取数据库列表出错。");
            }
        });
    }

    /**
     * 切换数据库
     * @param dbName
     * /
     function useDatabase(form, dbName) {
        console.debug("[useDatabase] form = " + form + ", dbName = " + dbName);
        $.ajax({
            type: 'get',
            url: '${pageContext.request.contextPath}/dbadmin/database/useDatabase/' + dbName.field,

            beforeSend: function () {
                console.log('[getTableList] 执行请求：url = ' + this.url);
            },

            success: function (queriedTableList) {
                getTableList(form, dbName);
            },

            error: function () {
                console.error("[getTableList] 选择数据表出错");
                alert("选择数据表出错。");
            }
        });
    }

     /**
     * 获取指定数据库的所有表
     * @param form
     * @param dbName
     */
    function getTableList(form, dbName) {
        console.debug("[getTableList] form = " + form + ", dbName = " + dbName);
        $.ajax({
            type: 'get',
            url: conf.contextPath + '/showTables',
            data: dbName.field,

            beforeSend: function () {
                console.log('[getTableList] 执行请求：url = ' + this.url);
            },

            success: function (queriedTableList) {
                console.log("[getTableList] url = " + this.url + ", response = " + queriedTableList);
                queriedTableList = JSON.parse(queriedTableList);

                var option = '';
                for (var i = 0; i < queriedTableList.length; i++) {
                    option += "<option value='" + queriedTableList[i] + "'>" + queriedTableList[i] + "</option>";
                }
                $("#tableListId").html(option);
                form.render('select', 'tableListFilter');
            },

            error: function () {
                console.error("[getTableList] 选择数据表出错");
                alert("选择数据表出错。");
            }
        });
    }
</script>

</body>
</html>